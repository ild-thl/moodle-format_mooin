{"version":3,"file":"ildhvp4.min.js","sources":["../src/ildhvp4.js"],"sourcesContent":["define([\n  \"jquery\",\n  \"core/ajax\",\n  \"core/notification\",\n  \"core/str\",\n  \"core/url\",\n  \"core/modal_factory\",\n  \"format_mooin4/mooin4Modal\",\n  \"format_mooin4/modalGenerator\",\n], function (\n  $,\n  ajax,\n  notification,\n  Str,\n  Url,\n  ModalFactory,\n  Mooin4Modal,\n  generateModal\n) {\n  /** @namespace */\n  var ILD = ILD || {};\n\n  /**\n   * Interactions counter\n   * @type {Array}\n   */\n  ILD.interactions = [];\n\n  /**\n   * SingelChoiceInteractions counter\n   * @type {Array}\n   */\n  ILD.singleChoiceInteractions = [];\n\n  /**\n   * SubContentIds - avoid duplicated answered statement\n   * @type {Array}\n   */\n  ILD.subIds = [];\n\n  /**\n   * Stores QuestionSet PassPercentage\n   * @type {Array}\n   */\n  ILD.questionSetPassPercentage = [];\n\n  /**\n   * Stores Essay PassPercentage\n   * @type {Array}\n   */\n  ILD.EssayPassPercentage = [];\n\n  /**\n   * Stores Branching scenario info\n   * @type {Array}\n   */\n  ILD.BranchingScenario = [];\n\n  /**\n   * Stores maxScore of interactions\n   * @type {Int}\n   */\n  ILD.maxScore = 0;\n\n  /**\n   * Stores score of interactions\n   * @type {Float}\n   */\n  ILD.score = 0;\n\n  /**\n   * Stores percentage of interactions progress\n   * @type {Float}\n   */\n  ILD.percentage = 0;\n\n  /**\n   * Internal H5P function listening for xAPI answered events and stores scores.\n   *\n   * @param {H5P.XAPIEvent} event\n   */\n  ILD.xAPIAnsweredListener = function (event) {\n    var contentId = event.getVerifiedStatementValue([\n      \"object\",\n      \"definition\",\n      \"extensions\",\n      \"http://h5p.org/x-api/h5p-local-content-id\",\n    ]);\n    var isInteraction = false;\n\n    if (event.data.statement.object.objectType == \"Activity\") {\n      isInteraction = true;\n    }\n\n    if (\n      isInteraction &&\n      event.getVerb() === \"answered\" &&\n      typeof ILD.questionSetPassPercentage[contentId] === \"undefined\" &&\n      typeof ILD.singleChoiceInteractions[contentId] === \"undefined\" &&\n      typeof ILD.EssayPassPercentage[contentId] === \"undefined\" &&\n      typeof ILD.BranchingScenario[contentId] === \"undefined\"\n    ) {\n      var score = event.getScore();\n      var maxScore = event.getMaxScore();\n      var subContentId = event.data.statement.object.id;\n      subContentId = subContentId.split(\"subContentId=\");\n      subContentId = subContentId[1];\n\n      if (ILD.subIds.indexOf(subContentId) != -1) {\n        if (typeof ILD.interactions[contentId] === \"undefined\") {\n          ILD.interactions[contentId] = 1;\n        }\n\n        // ILD.score += score;\n        // ILD.maxScore += maxScore;\n        var interactions = ILD.interactions[contentId];\n\n        ILD.percentage =\n          ILD.percentage + (score / maxScore / interactions) * 100;\n\n        ILD.setResult(contentId, ILD.percentage, 100);\n      } else if (\n        ILD.subIds.indexOf(subContentId) == -1 &&\n        ILD.subIds.length == 0\n      ) {\n        var percentage = (score / maxScore) * 100;\n\n        ILD.setResult(contentId, percentage, 100);\n      }\n    }\n\n    // Check if QuestionSet is completed and percentage is set.\n    if (\n      typeof ILD.questionSetPassPercentage[contentId] !== \"undefined\" &&\n      event.getVerb() === \"completed\"\n    ) {\n      var score = event.getScore();\n      var maxScore = event.getMaxScore();\n      var percentage = (score / maxScore) * 100;\n      var passPercentage = ILD.questionSetPassPercentage[contentId];\n\n      if (percentage >= passPercentage) {\n        ILD.setResult(contentId, 100, 100);\n      } else {\n        ILD.setResult(contentId, percentage, 100);\n      }\n    }\n\n    // Check if Essay is scored.\n    if (\n      typeof ILD.EssayPassPercentage[contentId] !== \"undefined\" &&\n      event.getVerb() === \"scored\"\n    ) {\n      var score = event.getScore();\n      var maxScore = event.getMaxScore();\n      var percentage = (score / maxScore) * 100;\n\n      ILD.setResult(contentId, percentage, 100);\n    }\n\n    // Check if SingelChoiceSet is completed.\n    if (\n      typeof ILD.singleChoiceInteractions[contentId] !== \"undefined\" &&\n      event.getVerb() === \"completed\"\n    ) {\n      var score = event.getScore();\n      var maxScore = event.getMaxScore();\n      var percentage = (score / maxScore) * 100;\n\n      ILD.setResult(contentId, percentage, 100);\n    }\n\n    // Check if BranchingScenario is completed.\n    if (\n      typeof ILD.BranchingScenario[contentId] !== \"undefined\" &&\n      event.getVerb() === \"completed\"\n    ) {\n      ILD.setResult(contentId, 100, 100);\n    }\n  };\n\n  /**\n   * Post answered results for user and set progress.\n   *\n   * @param {number} contentId\n   *   Identifies the content\n   * @param {number} score\n   *   Achieved score/points\n   * @param {number} maxScore\n   *   The maximum score/points that can be achieved\n   */\n  ILD.setResult = function (contentid, score, maxScore) {\n    var promises = ajax.call([\n      {\n        methodname: \"format_mooin4_setgrade\",\n        args: { contentid: contentid, score: score, maxscore: maxScore },\n      },\n    ]);\n\n    promises[0]\n      .done(function (data) {\n        var div_id = String(\"mooin4ection\" + data.sectionid); // Oc-progress\n        var text_div_id = String(\"mooin4ection-text-\" + data.sectionid); // Oc-progress-text-\n\n        var percentage = Math.round(data.percentage);\n        var percentage_int = String(percentage + \"%\");\n        var percentage_text = String(percentage + \"%\" + \" \");\n\n        $(\"#\" + div_id, window.parent.document).css(\"width\", percentage_int);\n        $(\"#\" + text_div_id, window.parent.document).html(percentage_text);\n\n        if (data.percentage === 100) {\n          var navdrawerSection = window.parent.document.querySelector(\n            `[data-key=\"${data.sectionid}\"]`\n          );\n          navdrawerSection.classList.add(\"completed\");\n          var promises = ajax.call([\n            {\n              methodname: \"format_mooin4_check_completion_status\",\n              args: {\n                section_id: Number(data.sectionid),\n                isActivity: true,\n                course_already_completed: data.course_already_completed,\n                chapter_already_completed: data.chapter_already_completed\n              },\n            },\n          ]);\n          promises[0]\n            .done(function (data) {\n              var message = {\n                action: \"showModal\",\n                modal: { data },\n              };\n              window.top.postMessage(message, \"*\");\n            })\n            .fail();\n        }\n      })\n      .fail(function () {});\n  };\n\n  /**\n   * Count interactions layers from interactive video element.\n   *\n   * @param contentId\n   * @param content\n   */\n  ILD.getVideoInteractions = function (contentId, content) {\n    var interactions = content.interactiveVideo.assets.interactions;\n    var summaries = content.interactiveVideo.summary.task.params.summaries;\n    var notAllowedInteractions = [\n      \"H5P.Text\",\n      \"H5P.Table\",\n      \"H5P.Link\",\n      \"H5P.Image\",\n      \"H5P.GoToQuestion\",\n      \"H5P.Nil\",\n      \"H5P.IVHotspot\",\n    ];\n    var interactionsCounter = 0;\n    var summariesCounter = 0;\n\n    if (typeof interactions === \"object\") {\n      $.each(interactions, function (i) {\n        var library = interactions[i].action.library;\n        var subid = interactions[i].action.subContentId;\n        var foundItem = false;\n\n        $.each(notAllowedInteractions, function (j) {\n          if (library.indexOf(notAllowedInteractions[j]) > -1) {\n            foundItem = true;\n          }\n        });\n\n        if (!foundItem) {\n          interactionsCounter++;\n          ILD.subIds.push(subid);\n        }\n      });\n\n      ILD.interactions[contentId] = interactionsCounter;\n    }\n\n    if (\n      typeof interactions === \"undefined\" ||\n      (typeof interactions === \"object\" && interactionsCounter == 0)\n    ) {\n      $(\".h5p-iframe\")[0].contentWindow.onload = function () {\n        $(\".h5p-iframe\")[0].contentWindow.H5P.instances[0].video.on(\n          \"stateChange\",\n          function (event) {\n            if (event.data === 0) {\n              ILD.setResult(contentId, 100, 100);\n            }\n          }\n        );\n      };\n    }\n\n    if (summaries.length) {\n      var summary = false;\n\n      $.each(summaries, function (s) {\n        if (typeof summaries[s].summary !== \"undefined\") {\n          var subId = content.interactiveVideo.summary.task.subContentId;\n\n          ILD.subIds.push(subId);\n          summary = true;\n        }\n      });\n\n      if (summary) {\n        ILD.interactions[contentId] = interactionsCounter + 1;\n      }\n    }\n  };\n\n  /**\n   * Count interactions layers from SingleChoice element.\n   *\n   * @param contentId\n   * @param content\n   */\n  ILD.getSingleChoiceInteractions = function (contentId, content) {\n    var interactions = content.choices;\n\n    $.each(interactions, function (s) {\n      var subid = interactions[s].subContentId;\n      ILD.subIds.push(subid);\n    });\n\n    ILD.singleChoiceInteractions[contentId] = interactions.length;\n  };\n\n  /**\n   *\n   * @param contentId\n   * @param content\n   */\n  ILD.getQuestionSetPercentage = function (contentId, content) {\n    ILD.questionSetPassPercentage[contentId] = content.passPercentage;\n  };\n\n  /**\n   *\n   * @param contentId\n   * @param content\n   */\n  ILD.getEssayPercentage = function (contentId, content) {\n    ILD.EssayPassPercentage[contentId] = content.behaviour.percentagePassing;\n  };\n\n  /**\n   * Check if library is InteractiveVideo or QuestionSet.\n   */\n  ILD.checkLibrary = function () {\n    var contentId = $(\".h5p-iframe.h5p-initialized\").data(\"content-id\");\n\n    if (typeof contentId !== \"undefined\") {\n      var contentData = H5PIntegration.contents[\"cid-\" + contentId];\n      var content = JSON.parse(contentData.jsonContent);\n      var library = contentData.library;\n\n      if (library.indexOf(\"H5P.InteractiveVideo\") > -1) {\n        ILD.getVideoInteractions(contentId, content);\n      } else if (library.indexOf(\"H5P.QuestionSet\") > -1) {\n        ILD.getQuestionSetPercentage(contentId, content);\n      } else if (library.indexOf(\"H5P.SingleChoiceSet\") > -1) {\n        ILD.getSingleChoiceInteractions(contentId, content);\n      } else if (library.indexOf(\"H5P.Essay\") > -1) {\n        ILD.getEssayPercentage(contentId, content);\n      } else if (library.indexOf(\"H5P.BranchingScenario\") > -1) {\n        ILD.BranchingScenario[contentId] = 1;\n      }\n    }\n  };\n\n  return {\n    init: function () {\n      ILD.checkLibrary();\n      H5P.externalDispatcher.on(\"xAPI\", ILD.xAPIAnsweredListener);\n    },\n  };\n});\n"],"names":["define","$","ajax","notification","Str","Url","ModalFactory","Mooin4Modal","generateModal","ILD","interactions","singleChoiceInteractions","subIds","questionSetPassPercentage","EssayPassPercentage","BranchingScenario","maxScore","score","percentage","xAPIAnsweredListener","event","contentId","getVerifiedStatementValue","isInteraction","data","statement","object","objectType","getVerb","getScore","getMaxScore","subContentId","id","split","indexOf","setResult","length","contentid","call","methodname","args","maxscore","done","div_id","String","sectionid","text_div_id","Math","round","percentage_int","percentage_text","window","parent","document","css","html","querySelector","classList","add","section_id","Number","isActivity","course_already_completed","chapter_already_completed","message","action","modal","top","postMessage","fail","getVideoInteractions","content","interactiveVideo","assets","summaries","summary","task","params","notAllowedInteractions","interactionsCounter","_typeof","each","i","library","subid","foundItem","j","push","contentWindow","onload","H5P","instances","video","on","s","subId","getSingleChoiceInteractions","choices","getQuestionSetPercentage","passPercentage","getEssayPercentage","behaviour","percentagePassing","checkLibrary","contentData","H5PIntegration","contents","JSON","parse","jsonContent","init","externalDispatcher"],"mappings":"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"}
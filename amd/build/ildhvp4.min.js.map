{"version":3,"file":"ildhvp4.min.js","sources":["../src/ildhvp4.js"],"sourcesContent":["// Import der AbhÃ¤ngigkeiten\r\nimport $ from 'jquery';\r\nimport ajax from 'core/ajax';\r\nimport notification from 'core/notification';\r\nimport Str from 'core/str';\r\nimport Url from 'core/url';\r\nimport ModalFactory from 'core/modal_factory';\r\n\r\n// ILD Namespace Definition\r\nconst ILD = {};\r\n\r\n// Interactions counter\r\nILD.interactions = [];\r\n\r\n// SingleChoiceInteractions counter\r\nILD.singleChoiceInteractions = [];\r\n\r\n// SubContentIds - avoid duplicated answered statement\r\nILD.subIds = [];\r\n\r\n// Stores QuestionSet PassPercentage\r\nILD.questionSetPassPercentage = [];\r\n\r\n// Stores Essay PassPercentage\r\nILD.EssayPassPercentage = [];\r\n\r\n// Stores Branching scenario info\r\nILD.BranchingScenario = [];\r\n\r\n// Stores maxScore of interactions\r\nILD.maxScore = 0;\r\n\r\n// Stores score of interactions\r\nILD.score = 0;\r\n\r\n// Stores percentage of interactions progress\r\nILD.percentage = 0;\r\n\r\n// Internal H5P function listening for xAPI answered events and stores scores\r\nILD.xAPIAnsweredListener = (event) => {\r\n  const contentId = event.getVerifiedStatementValue([\r\n    'object',\r\n    'definition',\r\n    'extensions',\r\n    'http://h5p.org/x-api/h5p-local-content-id',\r\n  ]);\r\n  let isInteraction = false;\r\n\r\n  if (event.data.statement.object.objectType === 'Activity') {\r\n    isInteraction = true;\r\n  }\r\n\r\n  if (\r\n    isInteraction &&\r\n    event.getVerb() === 'answered' &&\r\n    typeof ILD.questionSetPassPercentage[contentId] === 'undefined' &&\r\n    typeof ILD.singleChoiceInteractions[contentId] === 'undefined' &&\r\n    typeof ILD.EssayPassPercentage[contentId] === 'undefined' &&\r\n    typeof ILD.BranchingScenario[contentId] === 'undefined'\r\n  ) {\r\n    const score = event.getScore();\r\n    const maxScore = event.getMaxScore();\r\n    let subContentId = event.data.statement.object.id.split('subContentId=')[1];\r\n\r\n    if (ILD.subIds.indexOf(subContentId) !== -1) {\r\n      if (typeof ILD.interactions[contentId] === 'undefined') {\r\n        ILD.interactions[contentId] = 1;\r\n      }\r\n\r\n      const interactions = ILD.interactions[contentId];\r\n      ILD.percentage += (score / maxScore / interactions) * 100;\r\n      ILD.setResult(contentId, ILD.percentage, 100);\r\n    } else if (ILD.subIds.indexOf(subContentId) === -1 && ILD.subIds.length === 0) {\r\n      const percentage = (score / maxScore) * 100;\r\n      ILD.setResult(contentId, percentage, 100);\r\n    }\r\n  }\r\n\r\n  // Handle QuestionSet completion\r\n  if (typeof ILD.questionSetPassPercentage[contentId] !== 'undefined' && event.getVerb() === 'completed') {\r\n    const score = event.getScore();\r\n    const maxScore = event.getMaxScore();\r\n    const percentage = (score / maxScore) * 100;\r\n    const passPercentage = ILD.questionSetPassPercentage[contentId];\r\n\r\n    if (percentage >= passPercentage) {\r\n      ILD.setResult(contentId, 100, 100);\r\n    } else {\r\n      ILD.setResult(contentId, percentage, 100);\r\n    }\r\n  }\r\n\r\n  // Handle Essay score\r\n  if (typeof ILD.EssayPassPercentage[contentId] !== 'undefined' && event.getVerb() === 'scored') {\r\n    const score = event.getScore();\r\n    const maxScore = event.getMaxScore();\r\n    const percentage = (score / maxScore) * 100;\r\n    ILD.setResult(contentId, percentage, 100);\r\n  }\r\n\r\n  // Handle SingleChoiceSet completion\r\n  if (typeof ILD.singleChoiceInteractions[contentId] !== 'undefined' && event.getVerb() === 'completed') {\r\n    const score = event.getScore();\r\n    const maxScore = event.getMaxScore();\r\n    const percentage = (score / maxScore) * 100;\r\n    ILD.setResult(contentId, percentage, 100);\r\n  }\r\n\r\n  // Handle BranchingScenario completion\r\n  if (typeof ILD.BranchingScenario[contentId] !== 'undefined' && event.getVerb() === 'completed') {\r\n    ILD.setResult(contentId, 100, 100);\r\n  }\r\n};\r\n\r\n// Post answered results for user and set progress\r\nILD.setResult = (contentId, score, maxScore) => {\r\n  window.console.log(score);\r\n  ILD.reactive.dispatch(\r\n    \"updateSectionprogress\",\r\n    ILD.sectionId,\r\n    contentId,\r\n    score,\r\n    maxScore\r\n  );\r\n  // ajax.call([\r\n  //   {\r\n  //     methodname: 'format_mooin4_setgrade',\r\n  //     args: { contentid: contentId, score, maxscore: maxScore },\r\n  //   },\r\n  // ]);\r\n};\r\n\r\n// Count interactions layers from interactive video element\r\nILD.getVideoInteractions = (contentId, content) => {\r\n  const interactions = content.interactiveVideo.assets.interactions;\r\n  const summaries = content.interactiveVideo.summary.task.params.summaries;\r\n  const notAllowedInteractions = ['H5P.Text', 'H5P.Table', 'H5P.Link', 'H5P.Image', 'H5P.GoToQuestion', 'H5P.Nil', 'H5P.IVHotspot'];\r\n\r\n  let interactionsCounter = 0;\r\n\r\n  if (typeof interactions === 'object') {\r\n    $.each(interactions, (i) => {\r\n      const library = interactions[i].action.library;\r\n      const subid = interactions[i].action.subContentId;\r\n\r\n      if (!notAllowedInteractions.some((item) => library.includes(item))) {\r\n        interactionsCounter++;\r\n        ILD.subIds.push(subid);\r\n      }\r\n    });\r\n\r\n    ILD.interactions[contentId] = interactionsCounter;\r\n  }\r\n\r\n  if (!interactions || (typeof interactions === 'object' && interactionsCounter === 0)) {\r\n\r\n//quick fix\r\n    /*\r\n    $('.h5p-iframe')[0].contentWindow.onload = () => {\r\n      $('.h5p-iframe')[0].contentWindow.H5P.instances[0].video.on('stateChange', (event) => {\r\n        if (event.data === 0) {\r\n        */\r\n    ILD.setResult(contentId, 100, 100);\r\n\r\n    //quick fix\r\n    /*\r\n  }\r\n});\r\n};\r\n*/\r\n  }\r\n\r\n  if (summaries.length) {\r\n    let summary = false;\r\n\r\n    $.each(summaries, (s) => {\r\n      if (typeof summaries[s].summary !== 'undefined') {\r\n        const subId = content.interactiveVideo.summary.task.subContentId;\r\n        ILD.subIds.push(subId);\r\n        summary = true;\r\n      }\r\n    });\r\n\r\n    if (summary) {\r\n      ILD.interactions[contentId] = interactionsCounter + 1;\r\n    }\r\n  }\r\n};\r\n\r\n// Count interactions layers from SingleChoice element\r\nILD.getSingleChoiceInteractions = (contentId, content) => {\r\n  const interactions = content.choices;\r\n\r\n  $.each(interactions, (s) => {\r\n    const subid = interactions[s].subContentId;\r\n    ILD.subIds.push(subid);\r\n  });\r\n\r\n  ILD.singleChoiceInteractions[contentId] = interactions.length;\r\n};\r\n\r\n// Get QuestionSet PassPercentage\r\nILD.getQuestionSetPercentage = (contentId, content) => {\r\n  ILD.questionSetPassPercentage[contentId] = content.passPercentage;\r\n};\r\n\r\n// Get Essay PassPercentage\r\nILD.getEssayPercentage = (contentId, content) => {\r\n  ILD.EssayPassPercentage[contentId] = content.behaviour.percentagePassing;\r\n};\r\n\r\n// Check if library is InteractiveVideo or QuestionSet\r\nILD.checkLibrary = (H5PIntegration, H5PInstance) => {\r\n\r\n  window.console.log(H5PInstance);\r\n  const contentId = H5PInstance.contentId;\r\n\r\n\r\n  if (typeof contentId !== 'undefined') {\r\n    const contentData = H5PIntegration.contents[`cid-${contentId}`];\r\n    const content = JSON.parse(contentData.jsonContent);\r\n    const library = contentData.library;\r\n\r\n\r\n    if (library.includes('H5P.InteractiveVideo')) {\r\n      ILD.getVideoInteractions(contentId, content);\r\n    } else if (library.includes('H5P.QuestionSet')) {\r\n      ILD.getQuestionSetPercentage(contentId, content);\r\n    } else if (library.includes('H5P.SingleChoiceSet')) {\r\n      ILD.getSingleChoiceInteractions(contentId, content);\r\n    } else if (library.includes('H5P.Essay')) {\r\n      ILD.getEssayPercentage(contentId, content);\r\n    } else if (library.includes('H5P.BranchingScenario')) {\r\n      ILD.BranchingScenario[contentId] = 1;\r\n    }\r\n  }\r\n};\r\n\r\n\r\nexport default {\r\n  init(H5PInstance, H5PIntegration, sectionId, reactive) {\r\n    ILD.sectionId = sectionId;\r\n    ILD.reactive = reactive;\r\n    ILD.checkLibrary(H5PIntegration, H5PInstance.instances[0]);\r\n    H5PInstance.externalDispatcher.on('xAPI', ILD.xAPIAnsweredListener);\r\n  },\r\n};\r\n"],"names":["ILD","event","contentId","getVerifiedStatementValue","isInteraction","data","statement","object","objectType","getVerb","questionSetPassPercentage","singleChoiceInteractions","EssayPassPercentage","BranchingScenario","score","getScore","maxScore","getMaxScore","subContentId","id","split","subIds","indexOf","interactions","percentage","setResult","length","window","console","log","reactive","dispatch","sectionId","content","interactiveVideo","assets","summaries","summary","task","params","notAllowedInteractions","interactionsCounter","each","i","library","action","subid","some","item","includes","push","s","subId","choices","passPercentage","behaviour","percentagePassing","H5PIntegration","H5PInstance","contentData","contents","JSON","parse","jsonContent","getVideoInteractions","getQuestionSetPercentage","getSingleChoiceInteractions","getEssayPercentage","init","checkLibrary","instances","externalDispatcher","on","xAPIAnsweredListener"],"mappings":"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"}
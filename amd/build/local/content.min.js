define("format_mooin4/local/content",["exports","core/reactive","core/utils","core_courseformat/courseeditor","core/inplace_editable","format_mooin4/local/content/section","format_mooin4/local/content/section/cmitem","core_course/actions","format_mooin4/local/content/actions","core_course/events","jquery","core/pending","core/log","core/str","core/modal_factory","core/templates","core/modal_events","../mooin4modal","format_mooin4/local/courseeditor/custommutations"],(function(_exports,_reactive,_utils,_courseeditor,_inplace_editable,_section,_cmitem,_actions,_actions2,CourseEvents,_jquery,_pending,_log,_str,_modal_factory,_templates,_modal_events,_mooin4modal,_custommutations){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Course index main component.
   *
   * @module     core_courseformat/local/content
   * @class      core_courseformat/local/content
   * @copyright  2020 Ferran Recio <ferran@moodle.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_inplace_editable=_interopRequireDefault(_inplace_editable),_section=_interopRequireDefault(_section),_cmitem=_interopRequireDefault(_cmitem),_actions=_interopRequireDefault(_actions),_actions2=_interopRequireDefault(_actions2),CourseEvents=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(CourseEvents),_jquery=_interopRequireDefault(_jquery),_pending=_interopRequireDefault(_pending),_log=_interopRequireDefault(_log),_modal_factory=_interopRequireDefault(_modal_factory),_templates=_interopRequireDefault(_templates),_modal_events=_interopRequireDefault(_modal_events),_mooin4modal=_interopRequireDefault(_mooin4modal),_custommutations=_interopRequireDefault(_custommutations);class Component extends _reactive.BaseComponent{create(descriptor){this.name="course_format",this.selectors={SECTION:"[data-for='section']",SECTION_ITEM:"[data-for='section_title']",SECTION_CMLIST:"[data-for='cmlist']",COURSE_SECTIONLIST:"[data-for='course_sectionlist']",CM:"[data-for='cmitem']",PAGE:"#page",TOGGLER:'[data-action="togglecoursecontentsection"]',COLLAPSE:'[data-toggle="collapse"]',TOGGLEALL:'[data-toggle="toggleall"]',ACTIVITYTAG:"li",SECTIONTAG:"li",INDEXNUMBER:"[data-for='index_number']",NAVIGATIONWRAPPER:"[data-for='navigation_wrapper']",NAVIGATIONTITLE:"[data-for='navigationtitle']",BREADCRUMB:"[data-for='breadcrumb']",PROGRESSBAR:"[data-for='progressbar_container']",PROGRESSBARINNER:"[data-for='progressbar_inner']",COMPLETIONBUTTON:"[data-for='complete-section']",SECTIONPROGRESS:"[data-for='section-progress']",TITLEOVERLAY:"[data-for='title-overlay']"},this.classes={COLLAPSED:"collapsed",ACTIVITY:"activity",STATEDREADY:"stateready",SECTION:"section",SCROLLUP:"scroll-up",SCROLLDOWN:"scroll-down",FADEOUT:"fade-out",ACTIVE:"active"},this.dettachedCms={},this.dettachedSections={},this.sections={},this.cms={},this.sectionReturn=descriptor.sectionReturn??0,this.debouncedReloads=new Map,this.lastScroll=0}static init(target,selectors,sectionReturn){return new Component({element:document.getElementById(target),reactive:(0,_courseeditor.getCurrentCourseEditor)(),selectors:selectors,sectionReturn:sectionReturn})}stateReady(state){this._indexContents(),this.addEventListener(this.element,"click",this._sectionTogglers);const toogleAll=this.getElement(this.selectors.TOGGLEALL);if(toogleAll){const collapseElementIds=[...this.getElements(this.selectors.COLLAPSE)].map((element=>element.id));toogleAll.setAttribute("aria-controls",collapseElementIds.join(" ")),this.addEventListener(toogleAll,"click",this._allSectionToggler),this.addEventListener(toogleAll,"keydown",(e=>{" "===e.key&&this._allSectionToggler(e)})),this._refreshAllSectionsToggler(state)}if(this.reactive.supportComponents){_actions2.default.addActions({completeSection:"completeSection"});const mutations=new _custommutations.default;this.reactive.isEditing&&(_actions2.default.addActions({sectionSetChapter:"sectionSetChapter",sectionUnsetChapter:"sectionUnsetChapter"}),this.reactive.addMutations({sectionSetChapter:mutations.sectionSetChapter,sectionUnsetChapter:mutations.sectionUnsetChapter})),new _actions2.default(this),this.reactive.addMutations({completeSection:mutations.completeSection,setContinueSection:mutations.setContinueSection,getContinueSection:mutations.getContinueSection,updateSectionprogress:mutations.updateSectionprogress,setLastSectionModal:mutations.setLastSectionModal,reloadAllSectionPrefixes:mutations.reloadAllSectionPrefixes}),this.element.classList.add(this.classes.STATEDREADY),this.reactive.dispatch("getContinueSection","section");this.getElements(this.selectors.SECTION).forEach((section=>{section.classList.contains(this.classes.ACTIVE)&&this.reactive.dispatch("setContinueSection","section",section.dataset.id)}))}this.addEventListener(this.element,CourseEvents.manualCompletionToggled,this._completionHandler),this.addEventListener(document.querySelector(this.selectors.PAGE),"scroll",this._scrollHandler)}_sectionTogglers(event){const sectionlink=event.target.closest(this.selectors.TOGGLER),closestCollapse=event.target.closest(this.selectors.COLLAPSE),isChevron=null==closestCollapse?void 0:closestCollapse.closest(this.selectors.SECTION_ITEM);if(sectionlink||isChevron){const section=event.target.closest(this.selectors.SECTION),toggler=section.querySelector(this.selectors.COLLAPSE),isCollapsed=(null==toggler?void 0:toggler.classList.contains(this.classes.COLLAPSED))??!1;if(isChevron||isCollapsed){const sectionId=section.getAttribute("data-id");this.reactive.dispatch("sectionContentCollapsed",[sectionId],!isCollapsed)}}}_allSectionToggler(event){event.preventDefault();const isAllCollapsed=event.target.closest(this.selectors.TOGGLEALL).classList.contains(this.classes.COLLAPSED),course=this.reactive.get("course");this.reactive.dispatch("sectionContentCollapsed",course.sectionlist??[],!isAllCollapsed)}getWatchers(){return this.reactive.sectionReturn=this.sectionReturn,this.reactive.supportComponents?[{watch:"cm.visible:updated",handler:this._reloadCm},{watch:"cm.stealth:updated",handler:this._reloadCm},{watch:"cm.indent:updated",handler:this._reloadCm},{watch:"section.number:updated",handler:this._refreshSectionNumber},{watch:"section.contentcollapsed:updated",handler:this._refreshSectionCollapsed},{watch:"transaction:start",handler:this._startProcessing},{watch:"course.sectionlist:updated",handler:this._refreshCourseSectionlist},{watch:"section.cmlist:updated",handler:this._refreshSectionCmlist},{watch:"section.visible:updated",handler:this._reloadSection},{watch:"section.isChapter:updated",handler:this._updateChapters},{watch:"state:updated",handler:this._indexContents},{watch:"cm.visible:updated",handler:this._reloadCm},{watch:"cm.sectionid:updated",handler:this._reloadCm},{watch:"section.sectionprogress:updated",handler:this._updateSectionProgress}]:[]}_refreshSectionCollapsed(_ref){let{state:state,element:element}=_ref;const target=this.getElement(this.selectors.SECTION,element.id);if(!target)throw new Error(`Unknown section with ID ${element.id}`);const toggler=target.querySelector(this.selectors.COLLAPSE),isCollapsed=(null==toggler?void 0:toggler.classList.contains(this.classes.COLLAPSED))??!1;if(element.contentcollapsed!==isCollapsed){let collapsibleId=toggler.dataset.target??toggler.getAttribute("href");if(!collapsibleId)return;collapsibleId=collapsibleId.replace("#","");const collapsible=document.getElementById(collapsibleId);if(!collapsible)return;(0,_jquery.default)(collapsible).collapse(element.contentcollapsed?"hide":"show")}this._refreshAllSectionsToggler(state)}_refreshAllSectionsToggler(state){const target=this.getElement(this.selectors.TOGGLEALL);if(!target)return;let allcollapsed=!0,allexpanded=!0;state.section.forEach((section=>{allcollapsed=allcollapsed&&section.contentcollapsed,allexpanded=allexpanded&&!section.contentcollapsed})),allcollapsed&&(target.classList.add(this.classes.COLLAPSED),target.setAttribute("aria-expanded",!1)),allexpanded&&(target.classList.remove(this.classes.COLLAPSED),target.setAttribute("aria-expanded",!0))}_startProcessing(){this.dettachedCms={},this.dettachedSections={}}_completionHandler(_ref2){let{detail:detail}=_ref2;void 0!==detail&&this.reactive.dispatch("cmCompletion",[detail.cmid],detail.completed)}_scrollHandler(){const pageOffset=document.querySelector(this.selectors.PAGE).scrollTop;this._titleoverlay(pageOffset),this.reactive.isEditing||this._dynamicHeader(pageOffset)}_dynamicHeader(pageOffset){const navigationHeader=this.getElement(this.selectors.NAVIGATIONWRAPPER),title=this.getElement(this.selectors.NAVIGATIONTITLE),progressbarContainer=this.getElement(this.selectors.PROGRESSBAR),breadcrumb=this.getElement(this.selectors.BREADCRUMB);if(title){var removeOffset,titleHeight=title.offsetHeight,progressbarContainerHeight=progressbarContainer.offsetHeight;if(removeOffset=window.innerHeight<=600?titleHeight+progressbarContainerHeight+20:titleHeight+20,pageOffset<=0)return void navigationHeader.classList.remove(this.classes.SCROLLUP);pageOffset>this.lastScroll&&!navigationHeader.classList.contains(this.classes.SCROLLDOWN)?(navigationHeader.classList.remove(this.classes.SCROLLUP),navigationHeader.classList.add(this.classes.SCROLLDOWN),navigationHeader.style.transform="translateY(-"+removeOffset+"px)",breadcrumb.style.transform="translateY("+removeOffset+"px)",title.style.transform="translateY("+removeOffset+"px)"):pageOffset<this.lastScroll&&navigationHeader.classList.contains(this.classes.SCROLLDOWN)&&(navigationHeader.classList.remove(this.classes.SCROLLDOWN),navigationHeader.classList.add(this.classes.SCROLLUP),navigationHeader.style.transform="translateY(0px)",breadcrumb.style.transform="translateY(0px)",title.style.transform="translateY(0px)",progressbarContainer.style.transform="translateY(0px)"),this.lastScroll=pageOffset}}_titleoverlay(pageOffset){const titleOverlay=this.getElement(this.selectors.TITLEOVERLAY);titleOverlay&&(pageOffset>130?titleOverlay.classList.add(this.classes.FADEOUT):titleOverlay.classList.remove(this.classes.FADEOUT))}_refreshSectionNumber(_ref3){let{state:state,element:element}=_ref3;const target=this.getElement(this.selectors.SECTION,element.id);if(!target)return;target.id=`section-${element.number}`,target.dataset.sectionid=element.number,target.dataset.number=element.number;const inplace=_inplace_editable.default.getInplaceEditable(target.querySelector(this.selectors.SECTION_ITEM));if(inplace){const currentvalue=inplace.getValue(),currentitemid=inplace.getItemId();""===inplace.getValue()&&(currentitemid!=element.id||currentvalue==element.rawtitle&&""!=element.rawtitle||inplace.setValue(element.rawtitle))}}_refreshSectionCmlist(_ref4){let{element:element}=_ref4;const cmlist=element.cmlist??[],section=this.getElement(this.selectors.SECTION,element.id),listparent=null==section?void 0:section.querySelector(this.selectors.SECTION_CMLIST),createCm=this._createCmItem.bind(this);listparent&&this._fixOrder(listparent,cmlist,this.selectors.CM,this.dettachedCms,createCm)}_refreshCourseSectionlist(_ref5){let{element:element}=_ref5;if(0!=this.reactive.sectionReturn)return;const sectionlist=element.sectionlist??[],listparent=this.getElement(this.selectors.COURSE_SECTIONLIST),createSection=this._createSectionItem.bind(this);listparent&&this._fixOrder(listparent,sectionlist,this.selectors.SECTION,this.dettachedSections,createSection)}_indexContents(){this._scanIndex(this.selectors.SECTION,this.sections,(item=>new _section.default(item))),this._scanIndex(this.selectors.CM,this.cms,(item=>new _cmitem.default(item)))}_scanIndex(selector,index,creationhandler){this.getElements(`${selector}:not([data-indexed])`).forEach((item=>{var _item$dataset;null!=item&&null!==(_item$dataset=item.dataset)&&void 0!==_item$dataset&&_item$dataset.id&&(void 0!==index[item.dataset.id]&&index[item.dataset.id].unregister(),index[item.dataset.id]=creationhandler({...this,element:item}),item.dataset.indexed=!0)}))}_reloadCm(_ref6){let{element:element}=_ref6;if(!this.getElement(this.selectors.CM,element.id))return;this._getDebouncedReloadCm(element.id)()}_getDebouncedReloadCm(cmId){const pendingKey=`courseformat/content:reloadCm_${cmId}`;let debouncedReload=this.debouncedReloads.get(pendingKey);if(debouncedReload)return debouncedReload;return debouncedReload=(0,_utils.debounce)((()=>{const pendingReload=new _pending.default(pendingKey);this.debouncedReloads.delete(pendingKey);const cmitem=this.getElement(this.selectors.CM,cmId);if(!cmitem)return pendingReload.resolve();return _actions.default.refreshModule(cmitem,cmId).then((()=>(this._indexContents(),!0))).catch((error=>{_log.default.debug(error)})).finally((()=>{pendingReload.resolve()})),pendingReload}),200,{cancel:!0,pending:!0}),this.debouncedReloads.set(pendingKey,debouncedReload),debouncedReload}_cancelDebouncedReloadCm(cmId){const pendingKey=`courseformat/content:reloadCm_${cmId}`,debouncedReload=this.debouncedReloads.get(pendingKey);debouncedReload&&(debouncedReload.cancel(),this.debouncedReloads.delete(pendingKey))}_reloadSection(_ref7){let{state:state,element:element}=_ref7;const pendingReload=new _pending.default(`courseformat/content:reloadSection_${element.id}`),sectionitem=this.getElement(this.selectors.SECTION,element.id);if(sectionitem){for(const cmId of element.cmlist)this._cancelDebouncedReloadCm(cmId);this.reactive.dispatch("reloadAllSectionPrefixes",element);_actions.default.refreshSection(sectionitem,element.id).then((()=>(this._indexContents(),this._reloadSectionNames({state:state,element:element}),!0))).catch((error=>{_log.default.debug(error)})).finally((()=>{pendingReload.resolve()}))}}_reloadSectionNames(_ref8){let{state:state,element:element}=_ref8;state.section.forEach((section=>{if(section.number>=element.number){const number=this.getElement(this.selectors.INDEXNUMBER,section.id);section.isChapter?number.innerHTML=section.isChapter:number.innerHTML=state.section.get(section.id).prefix}}))}_updateChapters(_ref9){let{state:state,element:element}=_ref9;window.console.log("chapter updated"),this._reloadSection({state:state,element:element})}_createCmItem(container,cmid){const newItem=document.createElement(this.selectors.ACTIVITYTAG);return newItem.dataset.for="cmitem",newItem.dataset.id=cmid,newItem.id=`module-${cmid}`,newItem.classList.add(this.classes.ACTIVITY),container.append(newItem),this._reloadCm({element:this.reactive.get("cm",cmid)}),newItem}_createSectionItem(container,sectionid){const section=this.reactive.get("section",sectionid),newItem=document.createElement(this.selectors.SECTIONTAG);return newItem.dataset.for="section",newItem.dataset.id=sectionid,newItem.dataset.number=section.number,newItem.id=`section-${sectionid}`,newItem.classList.add(this.classes.SECTION),container.append(newItem),this._reloadSection({element:section}),newItem}async _fixOrder(container,neworder,selector,dettachedelements,createMethod){if(void 0===container)return;if(!neworder.length)return container.classList.add("hidden"),void(container.innerHTML="");let dndFakeActivity;for(container.classList.remove("hidden"),neworder.forEach(((itemid,index)=>{let item=this.getElement(selector,itemid)??dettachedelements[itemid]??createMethod(container,itemid);if(void 0===item)return;const currentitem=container.children[index];void 0!==currentitem?currentitem!==item&&container.insertBefore(item,currentitem):container.append(item)}));container.children.length>neworder.length;){var _lastchild$classList;const lastchild=container.lastChild;var _lastchild$dataset;if(null!=lastchild&&null!==(_lastchild$classList=lastchild.classList)&&void 0!==_lastchild$classList&&_lastchild$classList.contains("dndupload-preview"))dndFakeActivity=lastchild;else dettachedelements[(null==lastchild||null===(_lastchild$dataset=lastchild.dataset)||void 0===_lastchild$dataset?void 0:_lastchild$dataset.id)??0]=lastchild;container.removeChild(lastchild)}dndFakeActivity&&container.append(dndFakeActivity)}async _updateSectionProgress(_ref10){let{state:state,element:element}=_ref10;this.getElement(this.selectors.PROGRESSBARINNER).style.width=element.sectionprogress+"%";this.getElement(this.selectors.SECTIONPROGRESS).innerText=element.sectionprogress;const completionbutton=this.getElement(this.selectors.COMPLETIONBUTTON);if(completionbutton){completionbutton.disabled=!0;const text=await(0,_str.get_string)("page_read","format_mooin4"),checkMark=document.createElement("i");checkMark.classList.add("bi","bi-check"),completionbutton.innerText=text,completionbutton.appendChild(checkMark)}const currentSection=state.section.get(element.id);let nextSection=null,completed=!0,allCompleted=!0;state.section.forEach((section=>{section.isCompleted||0==section.number||section.isChapter||(allCompleted=!1)})),state.section.forEach((section=>{section.parentChapter!==currentSection.parentChapter||section.isCompleted||(completed=!1),Number(section.parentChapter)===Number(currentSection.parentChapter)+1&&section.isFirstSectionOfChapter&&(nextSection=section)})),allCompleted?this._showCourseCompletedModal(state,nextSection):completed&&this._showChapterCompletedModal(state,nextSection)}async _showChapterCompletedModal(state,nextSection){const modal=await _modal_factory.default.create({type:_mooin4modal.default.TYPE,title:await(0,_str.get_string)("modal_chapter_complete_title","format_mooin4"),body:_templates.default.render("format_mooin4/local/content/modals/chaptercomplete",{}),footer:_templates.default.render("format_mooin4/local/content/modals/completechapterfooter",{nextSection:nextSection}),scrollable:!1});modal.show(),modal.showFooter()}async _showCourseCompletedModal(state){const modal=await _modal_factory.default.create({type:_mooin4modal.default.TYPE,title:await(0,_str.get_string)("modal_course_complete_title","format_mooin4"),body:_templates.default.render("format_mooin4/local/content/modals/coursecomplete",{}),footer:_templates.default.render("format_mooin4/local/content/modals/modalfooterclose",{}),scrollable:!1});modal.show(),modal.showFooter()}}return _exports.default=Component,_exports.default}));

//# sourceMappingURL=content.min.js.map
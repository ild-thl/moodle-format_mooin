define("format_mooin4/local/content/section",["exports","format_mooin4/local/content/section/header","format_mooin4/local/courseeditor/dndsection","core/templates","core/modal_factory","../../mooin4modal","core/str","format_mooin4/ildhvp4"],(function(_exports,_header,_dndsection,_templates,_modal_factory,_mooin4modal,_str,_ildhvp){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Course section format component.
   *
   * @module     core_courseformat/local/content/section
   * @class      core_courseformat/local/content/section
   * @copyright  2021 Ferran Recio <ferran@moodle.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_header=_interopRequireDefault(_header),_dndsection=_interopRequireDefault(_dndsection),_templates=_interopRequireDefault(_templates),_modal_factory=_interopRequireDefault(_modal_factory),_mooin4modal=_interopRequireDefault(_mooin4modal),_ildhvp=_interopRequireDefault(_ildhvp);class _default extends _dndsection.default{create(){this.name="content_section",this.selectors={SECTION_ITEM:"[data-for='section_title']",CM:'[data-for="cmitem"]',SECTIONINFO:'[data-for="sectioninfo"]',SECTIONBADGES:'[data-region="sectionbadges"]',SHOWSECTION:'[data-action="sectionShow"]',HIDESECTION:'[data-action="sectionHide"]',SETCHAPTER:'[data-action="sectionSetChapter"]',UNSETCHAPTER:'[data-action="sectionUnsetChapter"]',ACTIONTEXT:".menu-action-text",ICON:".icon",H5P:".parent-iframe"},this.classes={LOCKED:"editinprogress",HASDESCRIPTION:"description",HIDE:"d-none",HIDDEN:"hidden",CHAPTER:"chapter"},this.id=this.element.dataset.id}stateReady(state){if(this.configState(state),this.reactive.isEditing&&this.reactive.supportComponents){const sectionItem=this.getElement(this.selectors.SECTION_ITEM);if(sectionItem){const headerComponent=new _header.default({...this,element:sectionItem,fullregion:this.element});this.configDragDrop(headerComponent)}}this._showLastSectionModal(state),this._hvpListener()}getWatchers(){return[{watch:"section[".concat(this.id,"]:updated"),handler:this._refreshSection}]}validateDropData(dropdata){return("section"!==(null==dropdata?void 0:dropdata.type)||0==this.reactive.sectionReturn)&&super.validateDropData(dropdata)}getLastCm(){const cms=this.getElements(this.selectors.CM);return cms&&0!==cms.length?cms[cms.length-1]:null}_refreshSection(_ref){var _element$dragging,_element$locked,_element$visible,_element$isChapter;let{element:element}=_ref;this.element.classList.toggle(this.classes.DRAGGING,null!==(_element$dragging=element.dragging)&&void 0!==_element$dragging&&_element$dragging),this.element.classList.toggle(this.classes.LOCKED,null!==(_element$locked=element.locked)&&void 0!==_element$locked&&_element$locked),this.element.classList.toggle(this.classes.HIDDEN,null!==(_element$visible=!element.visible)&&void 0!==_element$visible&&_element$visible),this.element.classList.toggle(this.classes.CHAPTER,null!==(_element$isChapter=element.isChapter)&&void 0!==_element$isChapter&&_element$isChapter),this.locked=element.locked;const sectioninfo=this.getElement(this.selectors.SECTIONINFO);sectioninfo&&sectioninfo.classList.toggle(this.classes.HASDESCRIPTION,element.hasrestrictions),this._updateBadges(element),this._updateActionsMenu(element),this.reactive.isEditing}async _reloadSectionNames(_ref2){let{element:element}=_ref2;const title=this.getElement(this.selectors.SECTION_ITEM);element.isChapter||(title.innerHTML=element.prefix)}_updateBadges(section){const current=this.getElement("".concat(this.selectors.SECTIONBADGES," [data-type='iscurrent']"));null==current||current.classList.toggle(this.classes.HIDE,!section.current);const hiddenFromStudents=this.getElement("".concat(this.selectors.SECTIONBADGES," [data-type='hiddenfromstudents']"));null==hiddenFromStudents||hiddenFromStudents.classList.toggle(this.classes.HIDE,section.visible)}async _updateActionsMenu(section){var _affectedAction$datas,_affectedAction$datas2;let selector,newAction;section.visible?(selector=this.selectors.SHOWSECTION,newAction="sectionHide"):(selector=this.selectors.HIDESECTION,newAction="sectionShow"),section.isChapter?(selector=this.selectors.SETCHAPTER,newAction="sectionUnsetChapter"):(selector=this.selectors.UNSETCHAPTER,newAction="sectionSetChapter");const affectedAction=this.getElement(selector);if(!affectedAction)return;affectedAction.dataset.action=newAction;const actionText=affectedAction.querySelector(this.selectors.ACTIONTEXT);if(null!==(_affectedAction$datas=affectedAction.dataset)&&void 0!==_affectedAction$datas&&_affectedAction$datas.swapname&&actionText){const oldText=null==actionText?void 0:actionText.innerText;actionText.innerText=affectedAction.dataset.swapname,affectedAction.dataset.swapname=oldText}const icon=affectedAction.querySelector(this.selectors.ICON);if(null!==(_affectedAction$datas2=affectedAction.dataset)&&void 0!==_affectedAction$datas2&&_affectedAction$datas2.swapicon&&icon){const newIcon=affectedAction.dataset.swapicon;if(newIcon){const pixHtml=await _templates.default.renderPix(newIcon,"core");_templates.default.replaceNode(icon,pixHtml,"")}}}async _showLastSectionModal(state){const section=state.section.get(this.id);if(section.showLastSectionModal&&window.location.href==section.sectionurl.replace(/&amp;/g,"&")){const modal=await _modal_factory.default.create({type:_mooin4modal.default.TYPE,title:await(0,_str.get_string)("modal_last_section_of_chapter_title","format_mooin4"),body:_templates.default.render("format_mooin4/local/content/modals/lastsection",{}),footer:_templates.default.render("format_mooin4/local/content/modals/modalfooterclose",{}),scrollable:!1});modal.show(),modal.showFooter(),this.reactive.dispatch("setLastSectionModal",this.id)}}_hvpListener(){var parentIFrames=this.getElements(this.selectors.H5P);parentIFrames.length>0&&parentIFrames.forEach((parentIFrame=>{if(parentIFrame.contentDocument){var parentIFrameContent=parentIFrame.contentDocument||parentIFrame.contentWindow.document;let nestedIFrame=null;const adjustParentIFrameHeight=()=>{setTimeout((()=>{if(nestedIFrame&&nestedIFrame.contentWindow.document.body){const nestedIFrameHeight=nestedIFrame.contentWindow.document.body.scrollHeight;nestedIFrameHeight>1&&(parentIFrame.style.height=nestedIFrameHeight+"px")}}),100)},monitorElementLoads=()=>{["img","video","iframe","embed","object"].forEach((tag=>{const elements=nestedIFrame.contentDocument.getElementsByTagName(tag);for(let element of elements)element.addEventListener("load",adjustParentIFrameHeight),element.addEventListener("resize",adjustParentIFrameHeight)}))},checkForH5P=()=>{if(nestedIFrame){var H5PIntegration=nestedIFrame.contentWindow.H5PIntegration,H5P=nestedIFrame.contentWindow.H5P;if(H5P&&H5P.externalDispatcher)return H5P.setFinished=function(contentId,score,maxScore,time){},_ildhvp.default.init(H5P,H5PIntegration,this.id,this.reactive),adjustParentIFrameHeight(),new MutationObserver((function(mutations){mutations.forEach((function(mutation){(mutation.addedNodes.length>0||"src"===mutation.attributeName)&&adjustParentIFrameHeight()}))})).observe(nestedIFrame.contentDocument,{childList:!0,subtree:!0,attributes:!0}),!0}return!1},checkForNestedIFrame=()=>{if(nestedIFrame=parentIFrameContent.querySelector(".h5p-iframe"),nestedIFrame){if(nestedIFrame.addEventListener("load",(function(){adjustParentIFrameHeight(),checkForH5P(),monitorElementLoads()})),!checkForH5P())var h5pCheckInterval=setInterval((function(){checkForH5P()&&clearInterval(h5pCheckInterval)}),500);return!0}return!1};if(!checkForNestedIFrame()){var observer=new MutationObserver((function(mutations){mutations.forEach((function(mutation){mutation.addedNodes.length>0&&checkForNestedIFrame()&&observer.disconnect()}))}));observer.observe(parentIFrameContent,{childList:!0,subtree:!0})}}}))}_hvpprogress(event){if(window.console.log(event),"completed"===event.getVerb()||"answered"===event.getVerb()){var contentId=event.getVerifiedStatementValue(["object","definition","extensions","http://h5p.org/x-api/h5p-local-content-id"]),score=event.getScore(),maxScore=event.getMaxScore(),statement=event.data.statement;statement.context&&statement.context.contextActivities&&statement.context.contextActivities.parent&&statement.context.contextActivities.parent[0]&&statement.context.contextActivities.parent[0].id;this.reactive.dispatch("updateSectionprogress",this.id,contentId,score,maxScore)}}}return _exports.default=_default,_exports.default}));

//# sourceMappingURL=section.min.js.map